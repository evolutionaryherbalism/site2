name: Visual Regression Tests

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual regression tests
        env:
          URLS_CONFIG: ${{ vars.URLS_CONFIG }}
        run: npm test
        continue-on-error: true
        id: test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Send webhook notification on failure
        if: steps.test.outcome == 'failure'
        env:
          URLS_CONFIG: ${{ vars.URLS_CONFIG }}
          WEBHOOK_URL: ${{ vars.WEBHOOK_URL }}
        run: |
          if [ -f test-results/results.json ]; then
            node << 'SCRIPT'
              const fs = require('fs');
              const yaml = require('js-yaml');

              const results = JSON.parse(fs.readFileSync('test-results/results.json', 'utf8'));
              const webhook = process.env.WEBHOOK_URL;
              const reportUrl = `https://github.com/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

              // Load config to get URLs
              const config = process.env.URLS_CONFIG
                ? yaml.load(process.env.URLS_CONFIG)
                : yaml.load(fs.readFileSync('urls.yml', 'utf8'));

              const sitesMap = new Map(config.sites.map(s => [s.name, s.url]));

              // Send webhook for each failed test
              results.suites.forEach(suite => {
                suite.specs.forEach(spec => {
                  spec.tests.forEach(test => {
                    test.results.forEach(result => {
                      if (result.status === 'failed') {
                        const match = spec.title.match(/^(.+?) \((.+?)\)$/);
                        const name = match ? match[1] : spec.title;
                        const url = sitesMap.get(name) || 'unknown';

                        const payload = {
                          status: 'failed',
                          name: name,
                          url: url,
                          report_url: reportUrl
                        };

                        fetch(webhook, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify(payload)
                        }).catch(err => console.error('Webhook failed:', err));
                      }
                    });
                  });
                });
              });
            SCRIPT
          fi

      - name: Fail job if tests failed
        if: steps.test.outcome == 'failure'
        run: exit 1
